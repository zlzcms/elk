input {
  kafka {
    bootstrap_servers => "172.16.2.1:9092"
    topics => ["logs"]
    group_id => "logstash-group"
    consumer_threads => 1
    auto_offset_reset => "earliest"
    codec => "json"
    decorate_events => true
   # 添加SASL认证配置
    security_protocol => "SASL_PLAINTEXT"
    sasl_mechanism => "PLAIN"
    jaas_path => "/usr/share/logstash/config/jaas.conf"  # JAAS文件路径
  }
}


filter {
    if [log_type] {
        if [log_type] == "debug"  {
            grok {
                match => {
                    "message" => "%{TIMESTAMP_ISO8601:log_timestamp}\|\|%{DATA:service_name}\|\|%{LOGLEVEL:log_level}\|\|%{DATA:log_category}\|\|(?<log_message>.*?)(?:\|\|(?<extra_data>\{.*\}))?$"
                }
            }
            # 解析 log_message 中的 JSON
            if [log_message] and [log_message] != "" {
                if [log_message] =~ /^\{/ {
                    # 使用 ruby 过滤器处理转义字符并解析 JSON
                    ruby {
                        code => "
                            begin
                                log_msg = event.get('log_message')
                                if log_msg
                                    # 处理转义字符：将 \\\" 替换为 \"
                                    log_msg = log_msg.gsub(/\\\\\"/, '\"')
                                    # 处理转义字符：将 \\\\ 替换为 \\
                                    log_msg = log_msg.gsub(/\\\\\\\\/, '\\\\')
                                    
                                    # 尝试解析 JSON
                                    require 'json'
                                    parsed = JSON.parse(log_msg)
                                    event.set('log_message_data', parsed)
                                end
                            rescue => e
                                # 如果解析失败，记录错误但不中断处理
                                event.set('log_message_parse_error', e.message)
                            end
                        "
                    }
                }
            }

            # 解析 extra_data 中的 JSON
            if [extra_data] and [extra_data] != "" {
                if [extra_data] =~ /^\{/ {
                    ruby {
                        code => "
                            begin
                                extra = event.get('extra_data')
                                if extra
                                    # 处理转义字符
                                    extra = extra.gsub(/\\\\\"/, '\"')
                                    extra = extra.gsub(/\\\\\\\\/, '\\\\')
                                    
                                    # 尝试解析 JSON
                                    require 'json'
                                    parsed = JSON.parse(extra)
                                    event.set('log_data', parsed)
                                end
                            rescue => e
                                event.set('extra_data_parse_error', e.message)
                            end
                        "
                    }
                }
            }
        }
    }
}

output {
  elasticsearch {
    hosts => ["https://es01:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    ssl_enabled => true
    ssl_verification_mode => "none" 
    # ssl_certificate_authorities => "/usr/share/logstash/certs/ca/ca.crt"
    index => "kafka-logs-%{+YYYY.MM.dd}"
  }
  
  # 调试输出（可选，生产环境可以注释掉）
  stdout {
    codec => rubydebug
  }
}

